name: build
permissions:
  contents: read
on:
  workflow_call:
    inputs:
      matrix:
        required: true
        type: string
jobs:
  build:
    name: ${{ matrix.name }}
    strategy:
      matrix: ${{ fromJSON(inputs.matrix) }}
      fail-fast: false
    runs-on: ${{ matrix.os }}
    permissions:
      contents: read
    timeout-minutes: 30
    env:
      UNITY_EDITORS: '' # set by the unity-setup action
      UNITY_HUB_PATH: '' # set by the unity-setup action
      UNITY_EDITOR_PATH: '' # set by the unity-setup action
      UNITY_PROJECT_PATH: '' # set by the unity-setup action
      BUILD_OUTPUT_PATH: ${{ github.workspace }}/Builds/${{ matrix.build-target }}
    steps:
      - name: Free Disk Space
        if: ${{ matrix.os == 'ubuntu-latest' && (matrix.unity-version != '2018' && matrix.unity-version != '2017.4.40f1') }}
        uses: endersonmenezes/free-disk-space@713d134e243b926eba4a5cce0cf608bfd1efb89a # v2.1.1
        with:
          remove_android: true
          remove_dotnet: false
          remove_tool_cache: false
      - uses: actions/checkout@v5
      - uses: ./ # buildalon/unity-setup
        id: unity-setup
        with:
          version-file: None
          unity-version: ${{ matrix.unity-version }}
          build-targets: ${{ matrix.build-targets }}
          modules: ${{ matrix.modules }}
          auto-update-hub: ${{ !contains(matrix.modules, 'None') }}
          hub-version: ${{ contains(matrix.modules, 'None') && '3.12.0' || '' }}
      - run: |
          ENV_UNITY_HUB_PATH="${{ env.UNITY_HUB_PATH }}"
          echo "env.UNITY_HUB_PATH: \"${ENV_UNITY_HUB_PATH}\""
          STEPS_UNITY_HUB_PATH="${{ steps.unity-setup.outputs.unity-hub-path }}"
          echo "steps.unity-setup.outputs.unity-hub-path: \"${STEPS_UNITY_HUB_PATH}\""
          ENV_UNITY_EDITORS='${{ env.UNITY_EDITORS }}' # single quotes to preserve JSON format and quotes from breaking the script
          # The json string is raw and not escaped, which breaks echoing it directly. Escape quotes for safe echoing.
          ENV_UNITY_EDITORS="${ENV_UNITY_EDITORS//\"/\\\"}"
          echo "env.UNITY_EDITORS: \"${ENV_UNITY_EDITORS}\""
          STEPS_UNITY_EDITORS='${{ steps.unity-setup.outputs.unity-editors }}' # single quotes to preserve JSON format and quotes from breaking the script
          # The json string is raw and not escaped, which breaks echoing it directly. Escape quotes for safe echoing.
          STEPS_UNITY_EDITORS="${STEPS_UNITY_EDITORS//\"/\\\"}"
          echo "steps.unity-setup.outputs.unity-editors: \"${STEPS_UNITY_EDITORS}\""
          ENV_UNITY_EDITOR_PATH="${{ env.UNITY_EDITOR_PATH }}"
          echo "env.UNITY_EDITOR_PATH: \"${ENV_UNITY_EDITOR_PATH}\""
          STEPS_UNITY_EDITOR_PATH="${{ steps.unity-setup.outputs.unity-editor-path }}"
          echo "steps.unity-setup.outputs.unity-editor-path: \"${STEPS_UNITY_EDITOR_PATH}\""
          ENV_UNITY_PROJECT_PATH="${{ env.UNITY_PROJECT_PATH }}"
          echo "env.UNITY_PROJECT_PATH: \"${ENV_UNITY_PROJECT_PATH}\""
          STEPS_UNITY_PROJECT_PATH="${{ steps.unity-setup.outputs.unity-project-path }}"
          echo "steps.unity-setup.outputs.unity-project-path: \"${STEPS_UNITY_PROJECT_PATH}\""

          # validate both the env and output variables are the same
          if [[ "${ENV_UNITY_HUB_PATH}" != "${STEPS_UNITY_HUB_PATH}" ]]; then
            echo "Error: UNITY_HUB_PATH env and output do not match!"
            exit 1
          fi

          if [[ "${ENV_UNITY_EDITORS}" != "${STEPS_UNITY_EDITORS}" ]]; then
            echo "Error: UNITY_EDITORS env and output do not match!"
            exit 1
          fi
          
          if [[ "${ENV_UNITY_EDITOR_PATH}" != "${STEPS_UNITY_EDITOR_PATH}" ]]; then
            echo "Error: UNITY_EDITOR_PATH env and output do not match!"
            exit 1
          fi
          
          if [[ "${ENV_UNITY_PROJECT_PATH}" != "${STEPS_UNITY_PROJECT_PATH}" ]]; then
            echo "Error: UNITY_PROJECT_PATH env and output do not match!"
            exit 1
          fi
          
          # If unity-version is None, UNITY_EDITOR_PATH must be empty
          if [[ "${{ matrix.unity-version }}" == "None" ]]; then
            if [[ -n "${{ env.UNITY_EDITOR_PATH }}" ]]; then
              echo "Error: UNITY_EDITOR_PATH should be empty when unity-version is None, but got '${{ env.UNITY_EDITOR_PATH }}'"
              exit 1
            else
              echo "UNITY_EDITOR_PATH is correctly empty for unity-version=None."
              exit 0
            fi
          fi
          # Extract Unity version from UNITY_EDITOR_PATH using regex
          if [[ "${{ env.UNITY_EDITOR_PATH }}" =~ ([0-9]+\.[0-9]+\.[0-9]+[abcfpx]?[0-9]*) ]]; then
            UNITY_EDITOR_VERSION="${BASH_REMATCH[1]}"
            echo "Detected Unity Editor version: $UNITY_EDITOR_VERSION"
          else
            echo "Could not extract Unity version from UNITY_EDITOR_PATH: '${{ env.UNITY_EDITOR_PATH }}'"
            exit 1
          fi
          # Strip revision/hash from matrix.unity-version (e.g., '5.6.7f1 (e80cc3114ac1)' -> '5.6.7f1')
          MATRIX_UNITY_VERSION_PREFIX="${{ matrix.unity-version }}"
          if [[ "$MATRIX_UNITY_VERSION_PREFIX" =~ ^([0-9]+\.[0-9]+\.[0-9]+[abcfpx]?[0-9]*) ]]; then
            MATRIX_UNITY_VERSION_PREFIX="${BASH_REMATCH[1]}"
          fi
          # Support matrix.unity-version patterns ending with .x or .* after major.minor (e.g., 2021.3.x or 2021.3.*)
          if [[ "${{ matrix.unity-version }}" =~ ^([0-9]+\.[0-9]+)\.[x\*]$ ]]; then
            UNITY_MAJOR_MINOR="${BASH_REMATCH[1]}"
            if [[ "$UNITY_EDITOR_VERSION" == "$UNITY_MAJOR_MINOR"* ]]; then
              echo "Unity version matches matrix.unity-version: $UNITY_EDITOR_VERSION satisfies ${{ matrix.unity-version }}"
            else
              echo "Unity version mismatch: $UNITY_EDITOR_VERSION does not satisfy ${{ matrix.unity-version }}"
              exit 1
            fi
          # Support matrix.unity-version patterns ending with .x or .* after major (e.g., 2022.x or 2022.*)
          elif [[ "${{ matrix.unity-version }}" =~ ^([0-9]+)\.[x\*]$ ]]; then
            UNITY_MAJOR="${BASH_REMATCH[1]}"
            if [[ "$UNITY_EDITOR_VERSION" == "$UNITY_MAJOR"* ]]; then
              echo "Unity version matches matrix.unity-version: $UNITY_EDITOR_VERSION satisfies ${{ matrix.unity-version }}"
            else
              echo "Unity version mismatch: $UNITY_EDITOR_VERSION does not satisfy ${{ matrix.unity-version }}"
              exit 1
            fi
          # Support matrix.unity-version patterns with only major.minor (e.g., 2020.3)
          elif [[ "${{ matrix.unity-version }}" =~ ^([0-9]+\.[0-9]+)$ ]]; then
            UNITY_MAJOR_MINOR="${BASH_REMATCH[1]}"
            if [[ "$UNITY_EDITOR_VERSION" == "$UNITY_MAJOR_MINOR"* ]]; then
              echo "Unity version matches matrix.unity-version: $UNITY_EDITOR_VERSION satisfies ${{ matrix.unity-version }}"
            else
              echo "Unity version mismatch: $UNITY_EDITOR_VERSION does not satisfy ${{ matrix.unity-version }}"
              exit 1
            fi
          # Support matrix.unity-version patterns with only major (e.g., 6000)
          elif [[ "${{ matrix.unity-version }}" =~ ^([0-9]+)$ ]]; then
            UNITY_MAJOR="${BASH_REMATCH[1]}"
            if [[ "$UNITY_EDITOR_VERSION" == "$UNITY_MAJOR"* ]]; then
              echo "Unity version matches matrix.unity-version: $UNITY_EDITOR_VERSION satisfies ${{ matrix.unity-version }}"
            else
              echo "Unity version mismatch: $UNITY_EDITOR_VERSION does not satisfy ${{ matrix.unity-version }}"
              exit 1
            fi
          elif [[ "$UNITY_EDITOR_VERSION" == "$MATRIX_UNITY_VERSION_PREFIX" ]]; then
            echo "Unity version matches matrix.unity-version: $UNITY_EDITOR_VERSION satisfies ${{ matrix.unity-version }}"
          else
            echo "Unity version mismatch: $UNITY_EDITOR_VERSION does not satisfy ${{ matrix.unity-version }}"
            exit 1
          fi
        shell: bash
